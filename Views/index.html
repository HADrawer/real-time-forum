<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/Css/styles.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <title>Main Page</title>
    </head>

    <body>
        <script src="/Js/app.js"></script>
        <!-- the header is static between all pages except log in
        Note: we need to find a solution for log in page for header
        Maybe we can use {if log-in} {end} 
        -->
        {{if .IsLoggedIn}}
        <header>
            <div class="headerDiv">
                <div class="Project-Name"><a href="/">Real-Time Forum</a></div>
                <nav>
                <ul>
                    <li><a href="/Create"> Create Post</a></li>
                    <li><a href="/Direct">messages</a></li>
                    <button class="Headerbutton" id="logoutBtn">Log out</button>
                        <script>
                            document.getElementById("logoutBtn").addEventListener("click", () => {
                                 fetch("/logout", { method: "POST", credentials: "include" }) 
                                 .then(response => {
                                if (response.redirected) {
                                    window.location.href = response.url; // Redirect to homepage
                                }
                              })
                            .catch(error => console.error("Logout failed:", error));
                        });
                        </script>
                </ul>
                </nav>
                <!-- <h1 class="UserName">hashem</h1> -->
            </div>
        </header>
        {{end}}
        
        <main id="content">
                <!-- Dynamic contant-->

                <div class="sidebar">
                    <h2>Users</h2>
                    <ul class="user-list" id="userList">
                    </ul>
                </div>
                            
                <div class="chat-area">
                    <div class="chat-header">
                        Chat with <span id="chatWith"> </span>
                    </div>

                    <div class="chat-messages" id="messages">
                        <!-- Messages will appear here -->
                        
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." />
                        <button class="chat-send" id="sendMessage">Send</button>
                    </div>
                </div>     
                
                <script>
                    const socket = new WebSocket('ws://localhost:8080/ws');
                    const messagesContainer = document.getElementById('messages');
                    const messageInput = document.getElementById('messageInput');
                    const sendMessageButton = document.getElementById('sendMessage');
                    const userList = document.getElementById('userList');
                    const chatWith = document.getElementById('chatWith');

                    fetch('http://localhost:8080/users')
                        .then(response => response.json())
                        .then(users => {
                            users.forEach(user => {
                                const userItem = document.createElement('li');
                                userItem.textContent = user.username;
                                userItem.onclick = () => {
                                    chatWith.textContent = user.username;
                                };
                                userList.appendChild(userItem);
                            });
                        })
                        .catch(error => console.error('Error fetching users:', error));
                    
                        socket.onopen = () => {
                        const username = "You"; // This should be dynamically set based on the logged-in user
                         socket.send(JSON.stringify({ username: username }));
                        };      

            //             socket.onopen = () => {
            // console.log('Connected to WebSocket');
            // // Send username once connected
            // const username = prompt('Enter your username:');
            // socket.send(JSON.stringify(username)); // Send username to server
            //             };

                    socket.onmessage = (event) => {
                            const msg =JSON.parse(event.data);
                            const messageDiv = document.createElement('div');
                            messageDiv.innerHTML = `<strong>${msg.username}:</strong> ${msg.message}`;
                            messagesContainer.appendChild(messageDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    };
                    
                    sendMessageButton.addEventListener('click', () => {
                        const message = messageInput.value;
                        if (message) {
                            const msg = {
                                username: 'You',
                                message: message
                            };
                            socket.send(JSON.stringify(msg));
                            messageInput.value = '';
                        }
                    });

                    messageInput.addEventListener('keypress', (e)=> {
                        if (e.key === 'Enter') {
                            sendMessageButton.click();
                        }
                    })

    
                </script>
                    
        </main>
        
        <footer>
            <p>&copy; 2025 Greatest Real-Time Forum .All rights reserved</p>
        </footer>
    </body>

</html>